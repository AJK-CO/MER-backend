<!DOCTYPE html>
<html>
<head>
    <title>Audio Recorder</title>
</head>
<body>
    <h1>Record Audio</h1>
    <button id="recordButton">Record</button>
    <button id="stopButton" disabled>Stop</button>
    <button id="saveWavButton" disabled>Save as WAV</button>
    <button id="saveMp3Button" disabled>Save as MP3</button>
    <audio id="audioPlayback" controls></audio>

    <!-- Include the lame.js library -->
    <script src="https://cdn.jsdelivr.net/npm/lamejs@1.2.0/lame.min.js"></script>

    <!-- Use ES Modules to include extendable-media-recorder -->
    <script type="module">
        import { MediaRecorder, register } from 'https://cdn.skypack.dev/extendable-media-recorder';
        import { connect } from 'https://cdn.skypack.dev/extendable-media-recorder-wav-encoder';

        let mediaRecorder = null;
        let audioBlobs = [];
        let capturedStream = null;

        async function initialize() {
            try {
                await register(await connect());
            } catch (error) {
                console.error('Failed to initialize encoder:', error);
            }
        }

        initialize();

        // Starts recording audio
        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: { echoCancellation: true } });
                audioBlobs = [];
                capturedStream = stream;

                mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/wav' });

                mediaRecorder.addEventListener('dataavailable', event => {
                    audioBlobs.push(event.data);
                });

                mediaRecorder.addEventListener('stop', () => {
                    const audioBlob = new Blob(audioBlobs, { type: 'audio/wav' });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    document.getElementById('audioPlayback').src = audioUrl;

                    // Enable save buttons
                    document.getElementById('saveWavButton').disabled = false;
                    document.getElementById('saveMp3Button').disabled = false;

                    // Save WAV file
                    document.getElementById('saveWavButton').onclick = () => {
                        const link = document.createElement('a');
                        link.href = audioUrl;
                        link.download = 'recording.wav';
                        link.click();
                    };

                    // Save MP3 file
                    document.getElementById('saveMp3Button').onclick = () => {
                        convertToMp3(audioBlob);
                    };
                });

                mediaRecorder.start();
                document.getElementById('recordButton').disabled = true;
                document.getElementById('stopButton').disabled = false;
            } catch (error) {
                console.error('Error accessing microphone:', error);
            }
        }

        // Stops recording audio
        function stopRecording() {
            if (mediaRecorder) {
                mediaRecorder.stop();
                capturedStream.getTracks().forEach(track => track.stop());
                document.getElementById('recordButton').disabled = false;
                document.getElementById('stopButton').disabled = true;
            }
        }

        // Convert WAV Blob to MP3
        function convertToMp3(wavBlob) {
            const reader = new FileReader();
            reader.readAsArrayBuffer(wavBlob);
            reader.onloadend = () => {
                const buffer = reader.result;
                const wav = lamejs.WavHeader.readHeader(new DataView(buffer));
                const samples = new Int16Array(buffer, wav.dataOffset, wav.dataLen / 2);

                const mp3Encoder = new lamejs.Mp3Encoder(1, wav.sampleRate, 128);
                const mp3Data = [];
                const sampleBlockSize = 1152;

                for (let i = 0; i < samples.length; i += sampleBlockSize) {
                    const sampleChunk = samples.subarray(i, i + sampleBlockSize);
                    const mp3buf = mp3Encoder.encodeBuffer(sampleChunk);
                    if (mp3buf.length > 0) {
                        mp3Data.push(mp3buf);
                    }
                }
                const mp3buf = mp3Encoder.flush();
                if (mp3buf.length > 0) {
                    mp3Data.push(mp3buf);
                }

                const mp3Blob = new Blob(mp3Data, { type: 'audio/mp3' });
                const mp3Url = URL.createObjectURL(mp3Blob);
                const link = document.createElement('a');
                link.href = mp3Url;
                link.download = 'recording.mp3';
                link.click();
            };
        }

        document.getElementById('recordButton').onclick = startRecording;
        document.getElementById('stopButton').onclick = stopRecording;
    </script>
</body>
</html>
